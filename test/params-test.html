<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../../test-fixture/test-fixture.html">
    <link rel="import" href="../rest-api.html">
  </head>
  <body>

    <test-fixture id="rest-api">
      <template is="dom-template">
        <rest-api url="{{apiUrl}}" params="{{apiParams}}">
          <rest-api-resource name="foos">
            <rest-api-resource name="bars" read-only></rest-api-resource>
          </rest-api-resource>
          <rest-api-resource name="bars" no-auto-fetch>
            <rest-api-resource name="quxes" read-only no-auto-fetch></rest-api-resource>
          </rest-api-resource>
        </rest-api>
      </template>
    </test-fixture>

    <script>

      var data = {
        apiUrl: '//rest-api.example.com',
        foos: [
          {id: 1},
          {id: 2},
          {id: 3}
        ],
        bars: [
          {id: 11, fooId: 1},
          {id: 12, fooId: 1},
          {id: 13, fooId: 2}
        ]
      };

      function cloneObject(obj) {
        var clone = {};
        Object.getOwnPropertyNames(obj).forEach(function(prop) {
          clone[prop] = obj[prop];
        });
        return clone;
      }

      function getApiUrl(url) {
        return data.apiUrl + url;
      }

      var restApi, foos, foosBars, bars, server;

      function createRestApiWithParams(done) {
        createRestApi(done, true);
      }

      function createRestApi(done) {
        var fixtureProperties = {apiUrl: data.apiUrl, apiParams: {customparam: 'value'}};
        restApi = fixture('rest-api', fixtureProperties);
        foos = Polymer.dom(restApi).children[0];
        bars = Polymer.dom(restApi).children[1];
        foosBars = Polymer.dom(foos).children[0];
        if (done) {
          afterServerResponse(foos, done);
        }
      }

      function afterServerResponse(target, callback) {
        var handler = function(event) {
          target.removeEventListener('response', handler);
          target.async(callback, 1);
        };
        target.addEventListener('response', handler);
        server.respond();
      }

      function serverRespondsWithJson(data) {
        server.respondWith([200, {"Content-Type": "application/json"}, JSON.stringify(data)]);
      }

      function expectRequest(method, url, body) {
        var request = server.requests[server.requests.length - 1];
        expect(request.method).to.equal(method);
        expect(request.url).to.equal(getApiUrl(url));
        if (body) {
          expect(request.requestBody).to.equal(JSON.stringify(body));
        }
      }

      beforeEach(function() {
        server = sinon.fakeServer.create();
        // Respond data.foos by default
        serverRespondsWithJson(data.foos);
      });

      describe('resource', function() {

       describe('CRUD-WITH-PARAMS', function() {


          beforeEach(createRestApiWithParams);


          it('should auto-fetch collection on name change with params', function(done) {

            serverRespondsWithJson(data.bars);

            foos.name = 'bars';

            expectRequest('GET', '/bars?customparam=value');
            afterServerResponse(foos, function() {done();});
          });

          it('should auto-fetch collection on name change with params and allowNonGetParams', function(done) {

            serverRespondsWithJson(data.bars);

            foos.allowNonGetParams = true;
            foos.name = 'bars';

            expectRequest('GET', '/bars?customparam=value');
            afterServerResponse(foos, function() {done();});
          });



          it('should create new item on collection push with params', function(done) {

            var newObj = {newKey: 'foo'};
            var newObjOnServer = cloneObject(newObj);
            newObjOnServer.id = 4;
            serverRespondsWithJson(newObjOnServer);

            foos.push('collection', newObj);

            expectRequest('POST', '/foos', newObj);
            afterServerResponse(foos, function() {done();});
          });


          it('should create new item on collection push with params and allowNonGetParams', function(done) {

            var newObj = {newKey: 'foo'};
            var newObjOnServer = cloneObject(newObj);
            newObjOnServer.id = 4;
            serverRespondsWithJson(newObjOnServer);

            foos.allowNonGetParams = true;
            foos.push('collection', newObj);

            expectRequest('POST', '/foos?customparam=value', newObj);
            afterServerResponse(foos, function() {done();});
          });


          it('should update the item on key change with params', function(done) {

            var newKey = 'foo';
            var newKeyOnServer = 'bar';
            serverRespondsWithJson({newKey: newKeyOnServer});

            foos.set('collection.0.newKey', newKey)

            expectRequest('PATCH', '/foos/' + data.foos[0].id, {newKey: newKey});
            afterServerResponse(foos, function() {done();});
          });

          it('should update the item on key change with params and allowNonGetParams', function(done) {

            var newKey = 'foo';
            var newKeyOnServer = 'bar';
            serverRespondsWithJson({newKey: newKeyOnServer});

            foos.allowNonGetParams = true;
            foos.set('collection.0.newKey', newKey)

            expectRequest('PATCH', '/foos/' + data.foos[0].id + '?customparam=value', {newKey: newKey});
            afterServerResponse(foos, function() {done();});
          });

          it('should update the item on replace with params', function(done) {

            var newItem = cloneObject(data.foos[0]);
            newItem.newKey = 'foo';
            var newItemOnServer = cloneObject(newItem);
            newItemOnServer.newKey = 'bar';
            serverRespondsWithJson(newItemOnServer);

            foos.set('collection.0', newItem);

            expectRequest('PUT', '/foos/' + data.foos[0].id, newItem);
            afterServerResponse(foos, function() {done();});
          });

          it('should update the item on replace with params and allowNonGetParams', function(done) {

            var newItem = cloneObject(data.foos[0]);
            newItem.newKey = 'foo';
            var newItemOnServer = cloneObject(newItem);
            newItemOnServer.newKey = 'bar';
            serverRespondsWithJson(newItemOnServer);

            foos.allowNonGetParams = true;
            foos.set('collection.0', newItem);

            expectRequest('PUT', '/foos/' + data.foos[0].id + '?customparam=value', newItem);
            afterServerResponse(foos, function() {done();});
          });


          it('should destroy item with params', function(done) {

            foos.pop('collection');

            expectRequest('DELETE', '/foos/' + data.foos[data.foos.length - 1].id);
            afterServerResponse(foos, function() {done();});
          });

          it('should destroy item with params and allowNonGetParams', function(done) {

            foos.allowNonGetParams = true;
            foos.pop('collection');

            expectRequest('DELETE', '/foos/' + data.foos[data.foos.length - 1].id + '?customparam=value');
            afterServerResponse(foos, function() {done();});
          });

        });
      });

    </script>

  </body>
</html>
